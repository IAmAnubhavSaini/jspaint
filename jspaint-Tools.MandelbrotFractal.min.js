/*! jspaint 2015-07-13 Anubhav Saini (c) 2015 */
$(function(){"use strict";var a={CONSTANTS:{id:"MandelbrotFractalTool",selectionId:"#MandelbrotFractalTool","class":"main-tool",title:"Click to draw Mandelbrot Fractal. Click again to disable.",maxHeight:-1,maxWidth:-1},VARIABLES:{iterations:1e3,xMax:1,yMax:1,xMin:-2,yMin:-1,height:-1,width:-1},start:function(b){function c(b){function c(a,b,c){for(var d=0,e=0,f=0,g=0,h=0,i=c;i--&&4>=f+g;)h=d*e,f=d*d,g=e*e,d=f-g+a,e=h+h+b;return c-i}function d(b){var d,e,f,g,h,i,j,k=b.context,l=b.XMin,m=b.YMin,n=b.XMax,o=b.YMax,p=b.iterations,q=a.VARIABLES.width,r=a.VARIABLES.height,s=k.getImageData(0,0,q,r),t=s.data,u=Color.hexToRgb(selectedPrimaryColor);for(d=0;q>d;++d)for(e=0;r>e;++e)f=l+(n-l)*d/(q-1),g=m+(o-m)*e/(r-1),h=c(f,g,p),j=4*(q*e+d),h>p?(t[j]=u.r,t[j+1]=u.g,t[j+2]=u.b):(i=3*Math.log(h)/Math.log(p-1),1>i?(t[j]=255*i,t[j+1]=0,t[j+2]=0):2>i?(t[j]=255,t[j+1]=255*(i-1),t[j+2]=0):(t[j]=255,t[j+1]=255,t[j+2]=255*(i-2))),t[j+3]=255;k.putImageData(s,b.startX,b.startY)}d(b)}var d=b.event,e=b.canvasId,f=a.VARIABLES.xMin,g=(a.VARIABLES.xMax,a.VARIABLES.yMin),h=a.VARIABLES.yMax;$(e).on(d,function(b){var d={event:b,relativeTo:$(e)},i=Actions.Mouse.getX(d),j=Actions.Mouse.getY(d),k=i-Math.floor(a.VARIABLES.width/2),l=j-Math.floor(a.VARIABLES.height/2);0>k&&(k=0),0>l&&(l=0),k+Math.floor(a.VARIABLES.width)>a.CONSTANTS.maxWidth&&(k-=k+Math.floor(a.VARIABLES.width)-a.CONSTANTS.maxWidth),l+Math.floor(a.VARIABLES.height)>a.CONSTANTS.maxHeight&&(l-=l+Math.floor(a.VARIABLES.height)-a.CONSTANTS.maxHeight),c({context:context,XMin:f,XMax:a.VARIABLES.xMax,YMin:g,YMax:h,iterations:a.VARIABLES.iterations,startX:k,startY:l})})},stop:function(a){$(a.canvasId).off(a.event)},ContextMenu:{activate:function(b){function c(a,b,c,d){return $('<input id="'+a+'" type="range" min="'+b+'" max="'+c+'" step="1" title="'+d+'" />')}function d(b){function d(b){var d=c("mandelbrotIterations","10",b.maxIterationsAllowed,"Iterations for mandelbrot fractal generation. Beware! If higher values are used, it might crash your browser.").attr("value",a.VARIABLES.iterations).on("mouseover",function(){$(this).attr("title",$(this).val())}).on("change",function(){var c=$(this).val();c>b.maxIterationsAllowed&&confirm("Beware! It might crash your browser. Go back?","back","No, I want these many iterations")&&(c=b.maxIterationsAllowed),a.VARIABLES.iterations=c});return d}return $('<label style="color: #FFFFFF; font-size: 10px;"></label>').append(b.iterationLabel).append(d(b))}function e(b){function d(b){var d=c("mandelbrotHeight","100",a.CONSTANTS.maxHeight,"Height for mandelbrot fractal generation.").attr("value",a.CONSTANTS.maxHeight).on("mouseover",function(){$(this).attr("title",$(this).val())}).on("change",function(){var b=$(this).val();b>a.CONSTANTS.maxHeight&&(b=a.CONSTANTS.maxHeight),a.VARIABLES.height=b});return d}return $('<label style="color: #FFFFFF; font-size: 10px;"></label>').append(b.heightLabel).append(d(b))}function f(b){function d(b){var d=c("mandelbrotWidth","100",a.CONSTANTS.maxWidth,"Width for mandelbrot fractal generation.").attr("value",a.CONSTANTS.maxWidth).on("mouseover",function(){$(this).attr("title",$(this).val())}).on("change",function(){var b=$(this).val();b>a.CONSTANTS.maxWidth&&(b=a.CONSTANTS.maxWidth),a.VARIABLES.width=b});return d}return $('<label style="color: #FFFFFF; font-size: 10px;"></label>').append(b.widthLabel).append(d(b))}function g(b){function d(b){var d=c("mandelbrotXMax","0","3","XMax for mandelbrot fractal generation.").attr("value","1").on("mouseover",function(){$(this).attr("title",$(this).val())}).on("change",function(){a.VARIABLES.xMax=$(this).val()});return d}return $('<label style="color: #FFFFFF; font-size: 10px;"></label>').append(b.xMaxLabel).append(d(b))}var h=$("<div></div>").attr("id",b.id).addClass("menu-item");h.append(d(b)),h.append(e(b)),h.append(f(b)),h.append(g(b)),h.appendTo($(b.containerSelectionCriterion))},deactivate:function(a){function b(a){$("#"+a.id).remove()}b(a)},getOptions:function(){return{tool:this,id:"MandelbrotFractalContextMenu",containerSelectionCriterion:".contextual-tool-bar",maxIterationsAllowed:2e3,minIterationsAllowed:10,iterationLabel:"Iterations: ",maxHeightAllowed:a.VARIABLES.maxHeight,heightLabel:"Height: ",maxWidthAllowed:a.VARIABLES.maxWidth,widthLabel:"Width: ",xMaxLabel:"XMax: ",yMaxLabel:"YMax: "}}},Events:{register:function(b){var c=b.toolId,d=$(c),e=a.ContextMenu;setupToolTips(d,a.CONSTANTS.title),b.tool=d,d.funcToggle("click",function(){activateTool(b),a.VARIABLES.height=a.CONSTANTS.maxHeight=$(b.canvasId)[0].height,a.VARIABLES.width=a.CONSTANTS.maxWidth=$(b.canvasId)[0].width,e.activate(e.getOptions())},function(){e.deactivate(e.getOptions()),deactivateTool(b)})}}};a.Events.register({toolId:a.CONSTANTS.selectionId,event:CONSTANTS.Events.mouseclick,canvasId:"#"+CONSTANTS.canvasId,start:a.start,stop:a.stop,toolName:"Mandelbrot fractal"})});